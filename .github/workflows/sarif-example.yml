# Purpose: Example GitHub Actions workflow demonstrating SARIF integration with GitHub Code Scanning
# Scope: CI/CD template for users integrating thailint SARIF output with GitHub security features
# Overview: Demonstrates how to run thailint linters with SARIF output and upload results to
#     GitHub Code Scanning. Runs multiple linters in parallel, generates separate SARIF files,
#     and uploads them for display in the repository's Security tab. Users can copy and adapt
#     this workflow for their own projects.
# Dependencies: actions/checkout, actions/setup-python, github/codeql-action/upload-sarif
# Exports: SARIF results to GitHub Code Scanning
# Environment: GitHub Actions ubuntu-latest runner
# Related: docs/sarif-output.md for comprehensive SARIF documentation

name: thailint SARIF Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger for testing
  workflow_dispatch:

# Required permissions for uploading SARIF results
permissions:
  security-events: write
  contents: read

jobs:
  # Run all thailint analyses in parallel
  analyze:
    name: Run thailint SARIF Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install thailint
        run: |
          pip install thailint
          thailint --version

      # Run each linter and save SARIF output
      # Using '|| true' ensures the workflow continues even if violations are found
      # Exit code 1 means violations found, which is expected behavior

      - name: Run nesting depth analysis
        run: |
          thailint nesting --format sarif src/ > nesting.sarif || true
          echo "Nesting analysis complete"

      - name: Run SRP analysis
        run: |
          thailint srp --format sarif src/ > srp.sarif || true
          echo "SRP analysis complete"

      - name: Run magic numbers analysis
        run: |
          thailint magic-numbers --format sarif src/ > magic-numbers.sarif || true
          echo "Magic numbers analysis complete"

      - name: Run DRY analysis
        run: |
          thailint dry --format sarif src/ > dry.sarif || true
          echo "DRY analysis complete"

      - name: Run file placement analysis
        run: |
          thailint file-placement --format sarif . > file-placement.sarif || true
          echo "File placement analysis complete"

      # Display summary of findings
      - name: Summarize findings
        run: |
          echo "=== SARIF Analysis Summary ==="
          for f in *.sarif; do
            count=$(jq '.runs[0].results | length' "$f")
            echo "$f: $count violations"
          done

      # Upload each SARIF file to GitHub Code Scanning
      # Using separate categories allows filtering in the Security tab

      - name: Upload nesting SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: nesting.sarif
          category: thailint-nesting
        continue-on-error: true

      - name: Upload SRP SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: srp.sarif
          category: thailint-srp
        continue-on-error: true

      - name: Upload magic numbers SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: magic-numbers.sarif
          category: thailint-magic-numbers
        continue-on-error: true

      - name: Upload DRY SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: dry.sarif
          category: thailint-dry
        continue-on-error: true

      - name: Upload file placement SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: file-placement.sarif
          category: thailint-file-placement
        continue-on-error: true

  # Optional: Fail the workflow if too many violations are found
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: analyze

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install thailint
        run: pip install thailint

      - name: Check nesting violations
        run: |
          thailint nesting --format sarif src/ > nesting.sarif || true
          COUNT=$(jq '.runs[0].results | length' nesting.sarif)
          echo "Nesting violations: $COUNT"
          if [ "$COUNT" -gt 10 ]; then
            echo "::error::Too many nesting violations ($COUNT > 10)"
            exit 1
          fi

      - name: Check SRP violations
        run: |
          thailint srp --format sarif src/ > srp.sarif || true
          COUNT=$(jq '.runs[0].results | length' srp.sarif)
          echo "SRP violations: $COUNT"
          if [ "$COUNT" -gt 5 ]; then
            echo "::error::Too many SRP violations ($COUNT > 5)"
            exit 1
          fi

      - name: Quality gate passed
        run: echo "âœ“ All quality gates passed!"
